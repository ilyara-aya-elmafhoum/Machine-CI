---
# Installer outils nécessaires
- name: Installer curl et dépendances
  apt:
    name:
      - curl
      - ca-certificates
      - tar
      - libicu-dev
    state: present
    update_cache: yes

# Créer l'utilisateur runner
- name: Créer utilisateur ansible-boot
  user:
    name: ansible-boot
    shell: /bin/bash
    create_home: yes

# Créer dossier runner
- name: Créer dossier runner
  file:
    path: /opt/actions-runner
    state: directory
    owner: ansible-boot
    group: ansible-boot
    mode: '0755'

# Télécharger GitHub Runner (SIMPLE)
- name: Télécharger GitHub Runner
  shell: |
    cd /opt/actions-runner
    curl -L -o runner.tar.gz https://github.com/actions/runner/releases/latest/download/actions-runner-linux-x64.tar.gz
  args:
    creates: /opt/actions-runner/runner.tar.gz

# Extraire runner
- name: Extraire GitHub Runner
  shell: |
    cd /opt/actions-runner
    tar xzf runner.tar.gz
  args:
    creates: /opt/actions-runner/config.sh

# Générer token runner GitHub
- name: Générer token GitHub Runner
  uri:
    url: "https://api.github.com/repos/{{ lookup('env','GITHUB_REPO') }}/actions/runners/registration-token"
    method: POST
    headers:
      Authorization: "Bearer {{ lookup('env','GITHUB_PAT') }}"
      Accept: "application/vnd.github+json"
    status_code: 201
  register: runner_token
  no_log: true

# Configurer runner
- name: Configurer GitHub Runner
  shell: |
    cd /opt/actions-runner
    ./config.sh \
      --url https://github.com/{{ lookup('env','GITHUB_REPO') }} \
      --token {{ runner_token.json.token }} \
      --unattended \
      --replace
  become_user: ansible-boot

# Installer service
- name: Installer service runner
  shell: |
    cd /opt/actions-runner
    ./svc.sh install

# Démarrer service
- name: Démarrer runner
  shell: |
    cd /opt/actions-runner
    ./svc.sh start
