---
# roles/github-runner/tasks/main.yml

# 0️⃣ Vérifier si le runner est déjà installé
- name: Vérifier si le runner est déjà installé
  stat:
    path: /opt/github-runner/config.sh
  register: runner_installed

# 1️⃣ Créer le groupe ansible-boot si nécessaire
- name: Créer le groupe ansible-boot
  group:
    name: ansible-boot
    state: present
  become: yes

# 2️⃣ Créer l'utilisateur ansible-boot si nécessaire
- name: Créer l'utilisateur ansible-boot
  user:
    name: ansible-boot
    shell: /bin/bash
    create_home: yes
    group: ansible-boot
  become: yes

# 3️⃣ Installer le runner uniquement s'il n'existe pas
- name: Installer et configurer le runner si absent
  block:
    # Créer le dossier du runner
    - name: Créer le dossier GitHub Runner
      file:
        path: /opt/github-runner
        state: directory
        mode: '0755'
        owner: ansible-boot
        group: ansible-boot
      become: yes

    # Télécharger le runner
    - name: Télécharger GitHub Runner
      get_url:
        url: "https://github.com/actions/runner/releases/download/v2.329.0/actions-runner-linux-x64-2.329.0.tar.gz"
        dest: /opt/github-runner/actions-runner-linux-x64.tar.gz
        mode: '0644'
        owner: ansible-boot
        group: ansible-boot
      become: yes

    # Extraire le runner
    - name: Extraire le runner
      unarchive:
        src: /opt/github-runner/actions-runner-linux-x64.tar.gz
        dest: /opt/github-runner
        remote_src: yes
        owner: ansible-boot
        group: ansible-boot
        extra_opts: [--strip-components=1]
      become: yes

    # Installer libicu pour Dotnet
    - name: Installer libicu pour Dotnet
      apt:
        name: libicu-dev
        state: present
      become: yes

    # Installer les dépendances Dotnet
    - name: Installer les dépendances Dotnet
      command: ./bin/installdependencies.sh
      args:
        chdir: /opt/github-runner
      become: yes

    # Générer token GitHub Runner via API
    - name: Générer token GitHub Runner via API
      uri:
        url: "https://api.github.com/repos/{{ github_repo }}/actions/runners/registration-token"
        method: POST
        headers:
          Authorization: "Bearer {{ github_pat }}"
          Accept: "application/vnd.github+json"
        return_content: yes
        status_code: 201
      register: runner_token_response
      no_log: true

    # Extraire le token
    - name: Extraire le token
      set_fact:
        github_token: "{{ runner_token_response.json.token }}"

    # Vérifier que le token est présent
    - name: Vérifier la présence du token
      fail:
        msg: "Le token GitHub Runner est vide ! Vérifie la variable github_pat."
      when: github_token is not defined or github_token | length < 10

    # Configurer le runner GitHub
    - name: Configurer le runner GitHub (config.sh)
      command: >
        ./config.sh
        --url https://github.com/{{ github_repo }}
        --token {{ github_token }}
        --unattended
        --replace
      args:
        chdir: /opt/github-runner
      become: yes
      become_user: ansible-boot

    # Installer le service GitHub Runner
    - name: Installer le service GitHub Runner
      shell: ./svc.sh install
      args:
        chdir: /opt/github-runner
      become: yes

  when: not runner_installed.stat.exists

# 4️⃣ Démarrer et activer le service (toujours idempotent)
- name: Démarrer le runner
  systemd:
    name: "actions.runner.{{ github_repo | regex_replace('/', '-') }}.machine-ci.service"
    state: started
    enabled: yes
  become: yes
